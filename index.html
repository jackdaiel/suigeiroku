<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="é…”é¯¨éŒ²">
    <meta name="mobile-web-app-capable" content="yes">
    <title>é…”é¯¨éŒ²</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Noto+Sans+JP:wght@300;400;500;700&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        html {
            font-size: 18px;
            height: 100%;
            height: -webkit-fill-available;
        }
        
        :root {
            --primary: #1a4d2e;
            --primary-light: #2d6a4f;
            --accent: #d4a574;
            --accent-light: #e8c9a0;
            --bg-dark: #0f1419;
            --bg-card: #1a2027;
            --text-primary: #e8e6e3;
            --text-secondary: #a8a29e;
            --border: #2d3748;
            --success: #22c55e;
            --error: #ef4444;
        }
        
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background: linear-gradient(135deg, #0f1419 0%, #1a2027 100%);
            color: var(--text-primary);
            min-height: 100vh;
            min-height: -webkit-fill-available;
            padding: 20px;
            padding-top: max(20px, env(safe-area-inset-top));
            padding-bottom: max(20px, env(safe-area-inset-bottom));
            -webkit-text-size-adjust: 100%;
            overflow-x: hidden;
        }
        
        .container { max-width: 1200px; margin: 0 auto; }
        
        header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px 0;
        }
        
        h1 {
            font-family: 'Playfair Display', serif;
            font-size: clamp(2.5rem, 5vw, 4rem);
            font-weight: 900;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-light) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
            letter-spacing: 0.05em;
        }
        
        .subtitle { font-size: 1rem; color: var(--text-secondary); letter-spacing: 0.2em; text-transform: uppercase; }
        
        .sync-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            border-radius: 20px;
            font-size: 1rem;
            margin-top: 15px;
            cursor: pointer;
        }
        
        .sync-status.connected { background: rgba(34,197,94,0.1); color: var(--success); border: 1px solid var(--success); }
        .sync-status.loading { background: rgba(245,158,11,0.1); color: #f59e0b; border: 1px solid #f59e0b; }
        .sync-status.error { background: rgba(239,68,68,0.1); color: var(--error); border: 1px solid var(--error); }
        
        .alert { padding: 15px 20px; border-radius: 8px; margin-bottom: 20px; animation: slideDown 0.3s ease; }
        .alert-success { background: rgba(34,197,94,0.1); border: 1px solid var(--success); color: var(--success); }
        .alert-error { background: rgba(239,68,68,0.1); border: 1px solid var(--error); color: var(--error); }
        
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        
        .tabs { display: flex; gap: 10px; margin-bottom: 30px; border-bottom: 1px solid var(--border); overflow-x: auto; -webkit-overflow-scrolling: touch; }
        
        .tab { padding: 18px 25px; background: transparent; border: none; color: var(--text-secondary); cursor: pointer; font-size: 1.1rem; font-weight: 500; transition: all 0.3s ease; border-bottom: 2px solid transparent; white-space: nowrap; }
        .tab:hover { color: var(--accent); }
        .tab.active { color: var(--accent); border-bottom-color: var(--accent); }
        
        .tab-content { display: none; animation: fadeIn 0.4s ease; }
        .tab-content.active { display: block; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .card { background: var(--bg-card); border-radius: 12px; padding: 25px; margin-bottom: 20px; border: 1px solid var(--border); box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
        .card h2 { font-family: 'Playfair Display', serif; color: var(--accent); margin-bottom: 20px; font-size: 1.5rem; }
        
        .input-group { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin-bottom: 20px; }
        
        .input-field { display: flex; flex-direction: column; }
        .input-field label { font-size: 1rem; color: var(--text-secondary); margin-bottom: 8px; font-weight: 500; }
        .input-field input, .input-field select { 
            padding: 16px; 
            background: var(--bg-dark); 
            border: 1px solid var(--border); 
            border-radius: 8px; 
            color: var(--text-primary); 
            font-size: 1.1rem; 
            transition: all 0.3s ease; 
        }
        .input-field input:focus, .input-field select:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(212,165,116,0.1); }
        
        .btn { padding: 18px 30px; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1.1rem; font-weight: 600; transition: all 0.3s ease; width: 100%; margin-top: 10px; }
        .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(29,77,46,0.4); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-secondary { background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%); }
        .btn-excel { background: linear-gradient(135deg, #217346 0%, #185c37 100%); }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: linear-gradient(135deg, var(--bg-card) 0%, #232a35 100%); padding: 20px; border-radius: 12px; border: 1px solid var(--border); text-align: center; }
        .stat-label { font-size: 1rem; color: var(--text-secondary); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.1em; }
        .stat-value { font-size: 2.5rem; font-weight: 700; color: var(--accent); font-family: 'Playfair Display', serif; }
        .stat-unit { font-size: 1rem; color: var(--text-secondary); margin-left: 5px; }
        
        .chart-container { position: relative; height: 300px; margin-bottom: 30px; }
        
        .records-list { max-height: 500px; overflow-y: auto; }
        .record-item { background: var(--bg-dark); padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 3px solid var(--accent); display: flex; justify-content: space-between; align-items: center; transition: all 0.3s ease; }
        .record-item:hover { transform: translateX(5px); }
        .record-date { font-weight: 600; color: var(--accent); margin-bottom: 8px; font-size: 1.1rem; }
        .record-details { font-size: 1rem; color: var(--text-secondary); line-height: 1.6; }
        
        .empty-state { text-align: center; padding: 60px 20px; color: var(--text-secondary); font-size: 1.1rem; }
        .empty-state-icon { font-size: 4rem; margin-bottom: 20px; opacity: 0.3; }
        
        #message-area { position: fixed; top: 20px; right: 20px; z-index: 1000; max-width: 400px; font-size: 1rem; }
        
        .summary-box { background: linear-gradient(135deg, var(--bg-dark) 0%, #1a1f28 100%); border: 2px solid var(--accent); border-radius: 12px; padding: 20px; margin: 25px 0; display: grid; gap: 15px; }
        .summary-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: rgba(212,165,116,0.05); border-radius: 8px; }
        .summary-item.highlight { background: linear-gradient(135deg, rgba(212,165,116,0.2) 0%, rgba(212,165,116,0.1) 100%); border: 1px solid var(--accent); padding: 20px; }
        .summary-label { font-size: 1.1rem; color: var(--text-secondary); font-weight: 500; }
        .summary-value { font-size: 1.5rem; font-weight: 700; color: var(--accent); font-family: 'Playfair Display', serif; }
        .summary-value-large { font-size: 2.5rem; font-weight: 900; color: var(--accent); font-family: 'Playfair Display', serif; }
        .summary-item.highlight .summary-label { font-size: 1.2rem; color: var(--accent); }
        
        @media (max-width: 768px) {
            .container { padding: 10px; }
            
            h1 { font-size: 3rem; }
            
            /* ã‚¿ãƒ–ã‚’å¤§ãã */
            .tab { 
                padding: 18px 20px; 
                font-size: 1.1rem;
                flex: 1;
                text-align: center;
            }
            
            /* å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã‚’å¤§ãã */
            .input-group { grid-template-columns: 1fr 1fr; gap: 12px; }
            .input-field label { font-size: 1rem; margin-bottom: 8px; }
            .input-field input, .input-field select { 
                padding: 16px; 
                font-size: 1.1rem;
                border-radius: 10px;
            }
            
            /* ä¿å­˜ãƒœã‚¿ãƒ³ã‚’å¤§ãã */
            .btn { 
                padding: 20px; 
                font-size: 1.1rem;
                border-radius: 12px;
                margin-top: 15px;
            }
            
            /* ã‚µãƒãƒªãƒ¼ãƒœãƒƒã‚¯ã‚¹ */
            .summary-label { font-size: 1rem; }
            .summary-value { font-size: 1.5rem; }
            .summary-value-large { font-size: 2.5rem; }
            
            /* çµ±è¨ˆã‚«ãƒ¼ãƒ‰ */
            .stats-grid { grid-template-columns: 1fr; gap: 15px; }
            .stat-label { font-size: 1rem; }
            .stat-value { font-size: 2.5rem; }
            
            /* ã‚°ãƒ©ãƒ• */
            .chart-container { height: 250px; }
            
            /* å±¥æ­´ */
            .record-date { font-size: 1.1rem; }
            .record-details { font-size: 1rem; line-height: 1.6; }
            
            /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ */
            .sync-status { font-size: 1rem; padding: 10px 20px; }
        }
    </style>
</head>
<body>
    <div id="message-area"></div>
    
    <div class="container">
        <header>
            <h1>é…”é¯¨éŒ²</h1>
            <p class="subtitle">Alcohol Tracking Journal</p>
            <div class="sync-status loading" id="sync-status" onclick="loadFromSheets()">
                â³ ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...
            </div>
        </header>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('input', event)">è¨˜éŒ²</button>
            <button class="tab" onclick="switchTab('stats', event)">çµ±è¨ˆ</button>
            <button class="tab" onclick="switchTab('history', event)">å±¥æ­´</button>
        </div>
        
        <div id="input-tab" class="tab-content active">
            <div class="card">
                <h2>ä»Šæ—¥ã®è¨˜éŒ²</h2>
                
                <div class="input-field" style="margin-bottom: 20px;">
                    <label>æ—¥ä»˜</label>
                    <input type="date" id="entry-date" />
                </div>
                
                <div class="input-group">
                    <div class="input-field">
                        <label>ğŸº Beer_ml</label>
                        <input type="number" id="beer" placeholder="0" min="0" step="10" />
                    </div>
                    <div class="input-field">
                        <label>ğŸ· Wine_ml</label>
                        <input type="number" id="wine" placeholder="0" min="0" step="10" />
                    </div>
                    <div class="input-field">
                        <label>ğŸ¶ Sake_ml</label>
                        <input type="number" id="sake" placeholder="0" min="0" step="10" />
                    </div>
                    <div class="input-field">
                        <label>ğŸ¥ƒ Whisky_ml</label>
                        <input type="number" id="whisky" placeholder="0" min="0" step="10" />
                    </div>
                    <div class="input-field">
                        <label>ğŸ¹ Shochu_ml</label>
                        <input type="number" id="shochu" placeholder="0" min="0" step="10" />
                    </div>
                    <div class="input-field">
                        <label>Other_ml</label>
                        <input type="number" id="other" placeholder="0" min="0" step="10" />
                    </div>
                </div>
                
                <div class="input-field" style="margin-bottom: 20px;">
                    <label>ğŸƒ Workout</label>
                    <select id="workout">
                        <option value="">ãªã—</option>
                        <option value="run">run</option>
                        <option value="muscle training">muscle training</option>
                        <option value="ride">ride</option>
                        <option value="swim">swim</option>
                        <option value="maranic">maranic</option>
                        <option value="muscle training+run">muscle training+run</option>
                        <option value="muscle training+walk">muscle training+walk</option>
                        <option value="muscle training+ride">muscle training+ride</option>
                    </select>
                </div>
                
                <div class="input-field">
                    <label>ğŸ”¥ Workout_kcal</label>
                    <input type="number" id="workout-kcal" placeholder="0" min="0" step="10" />
                </div>
                
                <div class="summary-box">
                    <div class="summary-item">
                        <div class="summary-label">ğŸº ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«ã‚«ãƒ­ãƒªãƒ¼</div>
                        <div class="summary-value" id="drink-kcal-display">0 kcal</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">ğŸ”¥ é‹å‹•ã‚«ãƒ­ãƒªãƒ¼</div>
                        <div class="summary-value" id="workout-kcal-display">0 kcal</div>
                    </div>
                    <div class="summary-item highlight">
                        <div class="summary-label">âš–ï¸ ã‚«ãƒ­ãƒªãƒ¼åæ”¯ (B - A)</div>
                        <div class="summary-value-large" id="balance-display">0 kcal</div>
                    </div>
                </div>
                
                <button class="btn" onclick="saveEntry()" id="save-btn">ğŸ’¾ è¨˜éŒ²ã‚’ä¿å­˜ï¼ˆã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«åŒæœŸï¼‰</button>
                <button class="btn btn-secondary" onclick="loadFromSheets()">ğŸ”„ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰å†èª­ã¿è¾¼ã¿</button>
                <button class="btn btn-excel" onclick="exportToExcel()" style="margin-top:10px;">ğŸ“¥ Excelå½¢å¼ã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
            </div>
        </div>
        
        <div id="stats-tab" class="tab-content">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">ä»Šæœˆã®å¹³å‡ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«é‡</div>
                    <div class="stat-value" id="avg-alcohol">0<span class="stat-unit">g</span></div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ä»Šæœˆã®å¹³å‡é‹å‹•æ¶ˆè²»é‡</div>
                    <div class="stat-value" id="avg-workout">0<span class="stat-unit">kcal</span></div>
                </div>
            </div>
            
            <div class="card">
                <h2>ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«é‡ã®æ¨ç§»ï¼ˆä»Šæœˆï¼‰</h2>
                <div class="chart-container">
                    <canvas id="alcohol-chart"></canvas>
                </div>
            </div>
            
            <div class="card">
                <h2>ã‚«ãƒ­ãƒªãƒ¼åæ”¯ï¼ˆä»Šæœˆã®ç´¯ç©ï¼‰</h2>
                <div class="chart-container">
                    <canvas id="calorie-chart"></canvas>
                </div>
            </div>
        </div>
        
        <div id="history-tab" class="tab-content">
            <div class="card">
                <h2>è¨˜éŒ²å±¥æ­´</h2>
                <div class="records-list" id="records-list"></div>
            </div>
        </div>
    </div>
    
    <script>
        const masterData = {
            beer: { alcohol: 5, kcal: 42, price: 55 },
            wine: { alcohol: 14, kcal: 70, price: 160 },
            sake: { alcohol: 15, kcal: 105, price: 167 },
            whisky: { alcohol: 40, kcal: 237, price: 571 },
            shochu: { alcohol: 25, kcal: 140, price: 139 },
            other: { alcohol: 0, kcal: 0, price: 0 }
        };
        
        let records = [];
        let alcoholChart = null;
        let calorieChart = null;
        
        function showMessage(message, type = 'success') {
            const area = document.getElementById('message-area');
            const div = document.createElement('div');
            div.className = `alert alert-${type}`;
            div.textContent = message;
            area.appendChild(div);
            setTimeout(() => div.remove(), 4000);
        }
        
        function init() {
            setTodayDate();
            setupInputListeners();
            loadFromSheets();
        }
        
        function setTodayDate() {
            document.getElementById('entry-date').value = new Date().toISOString().split('T')[0];
        }
        
        function setupInputListeners() {
            ['beer', 'wine', 'sake', 'whisky', 'shochu', 'other', 'workout-kcal'].forEach(id => {
                document.getElementById(id).addEventListener('input', updateSummary);
            });
            document.getElementById('entry-date').addEventListener('change', onDateChange);
        }
        
        // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
        function loadFromSheets() {
            const status = document.getElementById('sync-status');
            status.className = 'sync-status loading';
            status.textContent = 'â³ èª­ã¿è¾¼ã¿ä¸­...';
            
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.error) {
                        status.className = 'sync-status error';
                        status.textContent = 'âŒ èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼';
                        showMessage('ã‚¨ãƒ©ãƒ¼: ' + result.error, 'error');
                        return;
                    }
                    
                    records = result.records;
                    status.className = 'sync-status connected';
                    status.textContent = `âœ… ${result.count}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼ˆã‚¯ãƒªãƒƒã‚¯ã§å†èª­ã¿è¾¼ã¿ï¼‰`;
                    
                    updateStats();
                    updateCharts();
                    updateRecordsList();
                    showMessage(`âœ… ${result.count}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`, 'success');
                })
                .withFailureHandler(function(error) {
                    status.className = 'sync-status error';
                    status.textContent = 'âŒ èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼';
                    showMessage('èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                })
                .getData();
        }
        
        function onDateChange() {
            const date = document.getElementById('entry-date').value;
            const existing = records.find(r => r.date === date);
            
            if (existing) {
                document.getElementById('beer').value = existing.beer_ml || '';
                document.getElementById('wine').value = existing.wine_ml || '';
                document.getElementById('sake').value = existing.sake_ml || '';
                document.getElementById('whisky').value = existing.whisky_ml || '';
                document.getElementById('shochu').value = existing.shochu_ml || '';
                document.getElementById('other').value = existing.other_ml || '';
                document.getElementById('workout').value = existing.workout || '';
                document.getElementById('workout-kcal').value = existing.workout_kcal || '';
            } else {
                clearInputs();
            }
            updateSummary();
        }
        
        function clearInputs() {
            ['beer', 'wine', 'sake', 'whisky', 'shochu', 'other', 'workout-kcal'].forEach(id => {
                document.getElementById(id).value = '';
            });
            document.getElementById('workout').value = '';
        }
        
        function calculateEntry(entry) {
            let totalAlcohol = 0, totalKcal = 0, totalCost = 0;
            ['beer', 'wine', 'sake', 'whisky', 'shochu', 'other'].forEach(drink => {
                const ml = entry[drink + '_ml'] || 0;
                if (ml > 0 && masterData[drink]) {
                    totalAlcohol += (ml / 100) * masterData[drink].alcohol * 0.8;
                    totalKcal += (ml / 100) * masterData[drink].kcal;
                    totalCost += (ml / 100) * masterData[drink].price;
                }
            });
            return {
                alc_g: Math.round(totalAlcohol * 10) / 10,
                kcal: Math.round(totalKcal * 10) / 10,
                cost: Math.round(totalCost)
            };
        }
        
        function updateSummary() {
            const entry = {
                beer_ml: parseInt(document.getElementById('beer').value) || 0,
                wine_ml: parseInt(document.getElementById('wine').value) || 0,
                sake_ml: parseInt(document.getElementById('sake').value) || 0,
                whisky_ml: parseInt(document.getElementById('whisky').value) || 0,
                shochu_ml: parseInt(document.getElementById('shochu').value) || 0,
                other_ml: parseInt(document.getElementById('other').value) || 0
            };
            const workoutKcal = parseInt(document.getElementById('workout-kcal').value) || 0;
            const calculated = calculateEntry(entry);
            const balance = calculated.kcal - workoutKcal;
            
            document.getElementById('drink-kcal-display').textContent = `${Math.round(calculated.kcal)} kcal`;
            document.getElementById('workout-kcal-display').textContent = `${workoutKcal} kcal`;
            
            const balanceEl = document.getElementById('balance-display');
            balanceEl.textContent = `${balance >= 0 ? '+' : ''}${Math.round(balance)} kcal`;
            balanceEl.style.color = balance > 0 ? '#ef4444' : balance < 0 ? '#22c55e' : 'var(--accent)';
        }
        
        function saveEntry() {
            const date = document.getElementById('entry-date').value;
            if (!date) { showMessage('æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error'); return; }
            
            const btn = document.getElementById('save-btn');
            btn.disabled = true;
            btn.textContent = 'ä¿å­˜ä¸­...';
            
            const entry = {
                date: date,
                beer_ml: parseInt(document.getElementById('beer').value) || 0,
                wine_ml: parseInt(document.getElementById('wine').value) || 0,
                sake_ml: parseInt(document.getElementById('sake').value) || 0,
                whisky_ml: parseInt(document.getElementById('whisky').value) || 0,
                shochu_ml: parseInt(document.getElementById('shochu').value) || 0,
                other_ml: parseInt(document.getElementById('other').value) || 0,
                workout: document.getElementById('workout').value || '',
                workout_kcal: parseInt(document.getElementById('workout-kcal').value) || 0
            };
            
            const calculated = calculateEntry(entry);
            Object.assign(entry, calculated);
            
            // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ä¿å­˜
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.error) {
                        showMessage('ä¿å­˜ã‚¨ãƒ©ãƒ¼: ' + result.error, 'error');
                    } else {
                        // ãƒ­ãƒ¼ã‚«ãƒ«ã®recordsã‚‚æ›´æ–°
                        const existingIndex = records.findIndex(r => r.date === date);
                        if (existingIndex >= 0) {
                            records[existingIndex] = entry;
                        } else {
                            records.push(entry);
                            records.sort((a, b) => new Date(b.date) - new Date(a.date));
                        }
                        updateStats();
                        updateCharts();
                        updateRecordsList();
                        showMessage('âœ… ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ä¿å­˜ã—ã¾ã—ãŸï¼', 'success');
                    }
                    btn.disabled = false;
                    btn.textContent = 'ğŸ’¾ è¨˜éŒ²ã‚’ä¿å­˜ï¼ˆã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«åŒæœŸï¼‰';
                })
                .withFailureHandler(function(error) {
                    showMessage('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                    btn.disabled = false;
                    btn.textContent = 'ğŸ’¾ è¨˜éŒ²ã‚’ä¿å­˜ï¼ˆã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«åŒæœŸï¼‰';
                })
                .saveRecord(entry);
        }
        
        function updateStats() {
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth() + 1;
            const today = now.getDate();
            
            const thisMonthRecords = records.filter(r => {
                const d = new Date(r.date);
                return d.getFullYear() === currentYear && d.getMonth() + 1 === currentMonth;
            });
            
            const totalAlcohol = thisMonthRecords.reduce((sum, r) => sum + (r.alc_g || 0), 0);
            const totalWorkout = thisMonthRecords.reduce((sum, r) => sum + (r.workout_kcal || 0), 0);
            
            const avgAlcohol = today > 0 ? Math.round(totalAlcohol / today * 10) / 10 : 0;
            const avgWorkout = today > 0 ? Math.round(totalWorkout / today) : 0;
            
            document.getElementById('avg-alcohol').innerHTML = `${avgAlcohol}<span class="stat-unit">g</span>`;
            document.getElementById('avg-workout').innerHTML = `${avgWorkout}<span class="stat-unit">kcal</span>`;
        }
        
        function updateCharts() {
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth() + 1;
            const today = now.getDate();
            
            const allDates = [], alcoholData = [], alcoholColors = [];
            
            for (let day = 1; day <= today; day++) {
                const dateStr = `${currentYear}-${String(currentMonth).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
                allDates.push(`${currentMonth}/${day}`);
                const record = records.find(r => r.date === dateStr);
                const alcValue = record ? (record.alc_g || 0) : 0;
                alcoholData.push(alcValue);
                alcoholColors.push(day < today && alcValue === 0 ? '#fbbf24' : '#d4a574');
            }
            
            const restDayPlugin = {
                id: 'restDayMarker',
                afterDatasetsDraw(chart) {
                    const ctx = chart.ctx;
                    const meta = chart.getDatasetMeta(0);
                    meta.data.forEach((bar, index) => {
                        const day = index + 1;
                        if (day < today && alcoholData[index] === 0) {
                            ctx.save();
                            ctx.font = 'bold 20px Arial';
                            ctx.fillStyle = '#fbbf24';
                            ctx.textAlign = 'center';
                            ctx.textBaseline = 'bottom';
                            ctx.fillText('â­', bar.x, bar.y - 5);
                            ctx.restore();
                        }
                    });
                }
            };
            
            const ctxAlc = document.getElementById('alcohol-chart').getContext('2d');
            if (alcoholChart) alcoholChart.destroy();
            alcoholChart = new Chart(ctxAlc, {
                type: 'bar',
                data: {
                    labels: allDates,
                    datasets: [{ label: 'ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«é‡ (g)', data: alcoholData, backgroundColor: alcoholColors, borderColor: alcoholColors, borderWidth: 1 }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: '#a8a29e' } },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.y;
                                    const day = context.dataIndex + 1;
                                    if (day < today && value === 0) return 'ä¼‘è‚æ—¥ â­';
                                    return `ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«é‡: ${value}g`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: { beginAtZero: true, ticks: { color: '#a8a29e' }, grid: { color: 'rgba(45,55,72,0.5)' } },
                        x: { ticks: { color: '#a8a29e' }, grid: { color: 'rgba(45,55,72,0.5)' } }
                    }
                },
                plugins: [restDayPlugin]
            });
            
            const thisMonthRecords = [];
            let cumulativeDrink = 0, cumulativeWorkout = 0;
            const monthLabels = [], cumulativeDrinkData = [], cumulativeWorkoutData = [];
            
            for (let day = 1; day <= today; day++) {
                const dateStr = `${currentYear}-${String(currentMonth).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
                const record = records.find(r => r.date === dateStr);
                monthLabels.push(`${currentMonth}/${day}`);
                cumulativeDrink += record ? (record.kcal || 0) : 0;
                cumulativeWorkout += record ? (record.workout_kcal || 0) : 0;
                cumulativeDrinkData.push(Math.round(cumulativeDrink));
                cumulativeWorkoutData.push(Math.round(cumulativeWorkout));
            }
            
            const ctxCal = document.getElementById('calorie-chart').getContext('2d');
            if (calorieChart) calorieChart.destroy();
            calorieChart = new Chart(ctxCal, {
                type: 'line',
                data: {
                    labels: monthLabels,
                    datasets: [
                        { label: 'é£²é…’ã‚«ãƒ­ãƒªãƒ¼ç´¯ç©', data: cumulativeDrinkData, borderColor: '#ef4444', backgroundColor: 'rgba(239,68,68,0.1)', fill: true, tension: 0.3, pointRadius: 5, pointBackgroundColor: '#ef4444', borderWidth: 2 },
                        { label: 'é‹å‹•æ¶ˆè²»ç´¯ç©', data: cumulativeWorkoutData, borderColor: '#22c55e', backgroundColor: 'rgba(34,197,94,0.1)', fill: true, tension: 0.3, pointRadius: 5, pointBackgroundColor: '#22c55e', borderWidth: 2 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: '#a8a29e' } },
                        tooltip: {
                            callbacks: {
                                footer: function(tooltipItems) {
                                    const index = tooltipItems[0].dataIndex;
                                    const balance = cumulativeDrinkData[index] - cumulativeWorkoutData[index];
                                    return `åæ”¯: ${balance >= 0 ? '+' : ''}${balance} kcal`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: { beginAtZero: true, ticks: { color: '#a8a29e' }, grid: { color: 'rgba(45,55,72,0.5)' }, title: { display: true, text: 'ã‚«ãƒ­ãƒªãƒ¼ (kcal)', color: '#a8a29e' } },
                        x: { ticks: { color: '#a8a29e' }, grid: { color: 'rgba(45,55,72,0.5)' } }
                    }
                }
            });
        }
        
        function updateRecordsList() {
            const container = document.getElementById('records-list');
            if (records.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“</div><p>è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p></div>';
                return;
            }
            container.innerHTML = records.map(record => {
                const d = new Date(record.date);
                const dateStr = `${d.getFullYear()}å¹´${d.getMonth()+1}æœˆ${d.getDate()}æ—¥`;
                const drinks = [];
                if (record.beer_ml > 0) drinks.push(`ğŸº ${record.beer_ml}ml`);
                if (record.wine_ml > 0) drinks.push(`ğŸ· ${record.wine_ml}ml`);
                if (record.sake_ml > 0) drinks.push(`ğŸ¶ ${record.sake_ml}ml`);
                if (record.whisky_ml > 0) drinks.push(`ğŸ¥ƒ ${record.whisky_ml}ml`);
                if (record.shochu_ml > 0) drinks.push(`ğŸ¹ ${record.shochu_ml}ml`);
                if (record.other_ml > 0) drinks.push(`${record.other_ml}ml`);
                const drinkStr = drinks.length > 0 ? drinks.join(', ') : 'ä¼‘è‚æ—¥';
                const workoutStr = record.workout ? ` | ğŸƒ ${record.workout}` : '';
                return `<div class="record-item"><div><div class="record-date">${dateStr}</div><div class="record-details">${drinkStr}${workoutStr}<br>ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«: ${record.alc_g}g | ã‚«ãƒ­ãƒªãƒ¼: ${Math.round(record.kcal)}kcal</div></div></div>`;
            }).join('');
        }
        
        function switchTab(tabName, event) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');
        }
        
        function exportToExcel() {
            if (records.length === 0) { showMessage('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“', 'error'); return; }
            const monthGroups = {};
            records.forEach(record => {
                const date = new Date(record.date);
                const sheetName = date.getFullYear().toString().slice(2) + ('0'+(date.getMonth()+1)).slice(-2);
                if (!monthGroups[sheetName]) monthGroups[sheetName] = [];
                monthGroups[sheetName].push(record);
            });
            const wb = XLSX.utils.book_new();
            Object.keys(monthGroups).sort().reverse().forEach(sheetName => {
                const headers = ['Date','dow','Beer_ml','Beer_Alc_g','Wine_ml','Wine_Alc_g','Sake_ml','Sake_Alc_g','Whisky_ml','Whisky_Alc_g','Shochu_ml','Shochu_Alc_g','Chuhi_ml','Chuhi_Alc_g','Other_ml','Other_Alc_g','Alc_g_SUM','Drink_kcal','Cost_yen','Workout_act','Workout_kcal','B_minus_A'];
                const rows = monthGroups[sheetName].map(r => {
                    const date = new Date(r.date);
                    const dow = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][date.getDay()];
                    return [r.date,dow,r.beer_ml||0,((r.beer_ml||0)/100*5*0.8).toFixed(1),r.wine_ml||0,((r.wine_ml||0)/100*14*0.8).toFixed(1),r.sake_ml||0,((r.sake_ml||0)/100*15*0.8).toFixed(1),r.whisky_ml||0,((r.whisky_ml||0)/100*40*0.8).toFixed(1),r.shochu_ml||0,((r.shochu_ml||0)/100*25*0.8).toFixed(1),0,0,r.other_ml||0,0,r.alc_g||0,r.kcal||0,r.cost||0,r.workout||'',r.workout_kcal||0,((r.kcal||0)-(r.workout_kcal||0)).toFixed(1)];
                });
                const ws = XLSX.utils.aoa_to_sheet([headers, ...rows]);
                XLSX.utils.book_append_sheet(wb, ws, sheetName);
            });
            XLSX.writeFile(wb, `é…”é¯¨éŒ²_${new Date().toISOString().split('T')[0]}.xlsx`);
            showMessage('âœ… Excelã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Œäº†ï¼', 'success');
        }
        
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
